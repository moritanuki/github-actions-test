name: Test
on:
  push:
    branches:
      - test
      - main

jobs:
  hello_job:
    runs-on: ubuntu-latest
    # environment: ${{ github.ref_name == 'main' && 'dev' || github.ref_name }}
    steps:
      # ファイルをリポジトリからチェックアウト
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # - name: Set up .env file
      #   run: cp .env.${{ github.ref_name == 'main' && 'dev' || github.ref_name }} .env
      # - name: Show .env
      #   run: cat .env
      # - name: Hello
      #   run: echo ${{ vars.HELLO }}
      - name: 変更されたディレクトリを取得
        id: find-dirs
        run: |
          MODIFIED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | cut -d'/' -f1 | sort -u | grep -vE '^(layer-|auth-cognito|\.github)')
          echo "Modified directories: $MODIFIED_DIRS"
          echo "::set-output name=dirs::${MODIFIED_DIRS}"

      - name: 変更された各ディレクトリでビルドとデプロイを実行
        if: steps.find-dirs.outputs.dirs != ''
        run: |
          for dir in ${{ steps.find-dirs.outputs.dirs }}; do
            if [ -f "$dir/README.md" ]; then
              echo "Processing directory $dir"
          done
